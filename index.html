<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#4CAF50" />
  <title>Offline Survey Form</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {font-family: Arial, sans-serif; margin:20px; background:#f4f4f4;}
    .container{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08);}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px;margin-top:6px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box}
    button{margin-top:12px;padding:10px 14px;border-radius:6px;border:0;background:#007bff;color:#fff;cursor:pointer}
    .btn-secondary{background:#28a745}
    
    .products-grid{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .product-item{
      background:#f8f9fa;
      padding:12px;
      border-radius:6px;
      border:1px solid #dee2e6;
    }
    .product-header{
      font-weight:600;
      margin-bottom:8px;
      font-size:14px;
      color:#333;
    }
    .product-controls{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .status-group{
      display:flex;
      gap:16px;
      align-items:center;
      flex:1;
      min-width:300px;
    }
    .status-option{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .status-option input[type="checkbox"]{
      width:18px;
      height:18px;
      margin:0;
    }
    .status-option label{
      margin:0;
      font-weight:400;
      font-size:13px;
      cursor:pointer;
    }
    .price-group{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .price-group label{
      margin:0;
      font-weight:400;
      font-size:13px;
      white-space:nowrap;
    }
    .price-input{
      width:120px;
      padding:6px 8px;
      border:1px solid #ced4da;
      border-radius:4px;
      font-size:14px;
    }
    
    .thumb{max-width:220px;max-height:160px;border:1px solid #ddd;border-radius:6px;margin-top:8px}
    .status{margin-top:10px;padding:10px;border-radius:6px}
    .success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    h2{margin-top:18px}
    .camera-wrap{display:block;}
    .camera-wrap > div{margin-bottom:24px;}
    video{width:100%;max-width:320px;height:240px;border:1px solid #ddd;border-radius:6px;background:#000}
    canvas{display:none}
    ul{padding-left:18px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Offline Survey Form</h1>
    <div id="onlineStatus" class="status"></div>
    <form id="surveyForm">
      <label>Auditor Name</label>
      <input id="auditorName" type="text" required />
      
      <label>Area</label>
      <select id="area" required>
        <option value="">Select Area</option>
        <option value="Cavite">Cavite</option>
        <option value="Bulacan">Bulacan</option>
      </select>
      
      <label>Municipality</label>
      <select id="municipality" required>
        <option value="">Select Municipality</option>
      </select>
      
      <label>Barangay</label>
      <input id="barangay" type="text" required />
      
      <h2>Take a Photo of Store</h2>
      <div class="camera-wrap">
        <div>
          <video id="storeVideo" autoplay playsinline></video>
          <canvas id="storeCanvas"></canvas>
          <div>
            <button type="button" id="storeStartBtn">Start Camera</button>
            <button type="button" id="storeCaptureBtn">Capture</button>
          </div>
          <div><input id="storeFileInput" type="file" accept="image/*" capture="environment"></div>
          <img id="storeThumb" class="thumb" alt="store photo preview" />
        </div>
      </div>
      
      <label>What Ice Cream cabinet is available?</label>
      <select id="brand" required>
        <option value="">Select</option>
        <option value="Selecta">Selecta</option>
        <option value="Aice">Aice</option>
        <option value="Both">Both</option>
      </select>
      
      <label>Store Name</label>
      <select id="storeName" required>
        <option value="">Select store</option>
      </select>

      <label>Type of Store</label>
      <select id="typeStore" required>
        <option value="">Select Type</option>
        <option value="Bakery">Bakery</option>
        <option value="Carinderia inside palengke">Carinderia inside palengke</option>
        <option value="Eatery/Carinderia">Eatery/Carinderia</option>
        <option value="Grocery or wholesaler inside palengke">Grocery or wholesaler inside palengke</option>
        <option value="Sari-sari store">Sari-sari store</option>
        <option value="Wala sa nabanggit">Wala sa nabanggit</option>
      </select>
      
      <h2>Is the product available? (check and add price)</h2>
      <div id="productsContainer" class="products-grid"></div>

      <label>Ilan ang cabinet sa loob ng tindahan?</label>
      <input id="countCabinet" type="number" min="0" required />
      
      <h2>Take a picture of the freezer</h2>
      <div class="camera-wrap">
        <div>
          <video id="cabVideo" autoplay playsinline></video>
          <canvas id="cabCanvas"></canvas>
          <div>
            <button type="button" id="cabStartBtn">Start Camera</button>
            <button type="button" id="cabCaptureBtn">Capture</button>
          </div>
          <div><input id="cabFileInput" type="file" accept="image/*" capture="environment"></div>
          <img id="cabThumb" class="thumb" alt="Picture of the freezer preview" />
        </div>
      </div>
      
      <div style="margin-top:12px">
        <button type="submit" class="btn-secondary">üíæ Save Data (Local)</button>
        <button type="button" id="syncBtn">‚òÅÔ∏è Sync to Google Sheets</button>
      </div>
    </form>
    <div id="statusMessage" class="status"></div>
    <h2>Locally Saved Data (<span id="entryCount">0</span>)</h2>
    <ul id="dataList"></ul>
    <button id="clearLocalBtn" style="background:#6c757d;color:#fff;border:0;padding:10px;border-radius:6px">Clear Local Data</button>
  </div>
<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCEbZ6ngbl3oY8aBdXWGVoG2VTTNWwEi6KskawmpCq21Y_uctAWkoFkr3tee6oCJo5JA/exec';

const municipalities = {
  "Cavite": [
    "DASMA", "BACOOR", "GENERAL TRIAS", "IMUS", "TANZA", "SILANG", "TRECE", 
    "GEN MARIANO", "NAIC", "KAWIT"
  ],
  "Bulacan": [
    "SJDM", "SANTA MARIA", "MALOLOS", "MARILAO", "MEYCAUAYAN", "SAN MIGUEL",
    "BALIWAG", "PANDI", "BOCAUE", "NORZAGARAY", "HAGONOY", "CALUMPIT",
    "SAN ILDEFONSO", "PLARIDEL", "GUIGUINTO"
  ]
};

const brandStores = {
  "Selecta":[
    "R-JAY STORE","AZORES EASTERY","CJ and AJ STORE","CAI VARIETY STORE","DRC SCHOOL SUPPLIES",
    "JHONNEL VAREITY STORE","KEANS STORE","KIM AND J STORE","OHH--SAINT BERNADETTE STORE","MLR STORE"
  ],
  "Aice":[
    "MLR STORE","CAI VARIETY STORE","R-JAY STORE","JHONNEL VARIETY STORE","RBKAH STORE",
    "MJ PEREZ","BEVERLY STORE","BOOGIE STORE","TESS STORE","DADAY BURGER"
  ]
};

const productsList = {
  "Selecta":[
    "CHOKY","WATERMELON SLICE","ICE POP BERRY CHOCO","ICE POP MILKY CHOCO","RAINBOW POP",
    "BOOM BOOM CHOCO","BOOM BOOM COOKIES AND CREAM","CRUNCHY MAX CHOCOLATE","WONDER WAFFLE",
    "CHOCO CUP","UBE CUP","MANGO CUP","DOUBLE CHOCO SUNDAE","BITES TIME! VANILLA TOFFEE CARAMEL",
    "CORNETTO CHOCOLATE","CORNETTO COOKIES AND CREAM","CORNETTO VANILLA"
  ],
  "Aice":[
    "MILK STICK","CHOCOLATE STICK","WATERMELON SLICE","PINEAPPLE SLICE","JERUK SLICE / ORANGE SLICE",
    "MIKI MIKI CHOCOLATE","MIKI MIKI VANILLA","CHOCO MALT","CHECKERED STICK / 2 COLOR STICK",
    "MELON STICK"
  ]
};

const onlineStatus = document.getElementById('onlineStatus');
const areaEl = document.getElementById('area');
const municipalityEl = document.getElementById('municipality');
const brandEl = document.getElementById('brand');
const storeNameEl = document.getElementById('storeName');
const productsContainer = document.getElementById('productsContainer');
const surveyForm = document.getElementById('surveyForm');
const statusMessage = document.getElementById('statusMessage');
const dataList = document.getElementById('dataList');
const entryCount = document.getElementById('entryCount');
const syncBtn = document.getElementById('syncBtn');
const clearLocalBtn = document.getElementById('clearLocalBtn');

let offlineEntries = JSON.parse(localStorage.getItem('offlineEntries') || '[]');

const storeVideo = document.getElementById('storeVideo'), storeCanvas = document.getElementById('storeCanvas'), storeThumb = document.getElementById('storeThumb');
const cabVideo = document.getElementById('cabVideo'), cabCanvas = document.getElementById('cabCanvas'), cabThumb = document.getElementById('cabThumb');
const storeFileInput = document.getElementById('storeFileInput'), cabFileInput = document.getElementById('cabFileInput');

let storeStream = null, cabStream = null;
let storeDataURL = "", cabDataURL = "";
let currentLocation = { latitude: '', longitude: '', accuracy: '', timestamp: '' };

function updateOnlineStatus() {
  if (navigator.onLine){
    onlineStatus.textContent = 'üü¢ Online - You can sync data to Google Sheets';
    onlineStatus.className = 'status success';
  } else {
    onlineStatus.textContent = 'üî¥ Offline - Data will be saved locally';
    onlineStatus.className = 'status error';
  }
}

function displayStatus(msg, type) {
  statusMessage.textContent = msg;
  statusMessage.className = 'status ' + (type || '');
  setTimeout(()=>{ statusMessage.textContent = ''; statusMessage.className = 'status'; }, 6000);
}

// Get user's current location
function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      console.warn('Geolocation not supported');
      resolve({ latitude: '', longitude: '', accuracy: '', timestamp: '', error: 'Not supported' });
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const loc = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: new Date(position.timestamp).toISOString()
        };
        currentLocation = loc;
        console.log('Location captured:', loc);
        resolve(loc);
      },
      (error) => {
        console.warn('Location error:', error.message);
        resolve({ latitude: '', longitude: '', accuracy: '', timestamp: '', error: error.message });
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });
}

// Area change handler
areaEl.addEventListener('change', () => {
  const area = areaEl.value;
  municipalityEl.innerHTML = '<option value="">Select Municipality</option>';
  if (!area) return;
  
  const munis = municipalities[area] || [];
  munis.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    municipalityEl.appendChild(opt);
  });
});

// Brand change handler
brandEl.addEventListener('change', () => {
  const b = brandEl.value;
  storeNameEl.innerHTML = '<option value="">Select store</option>';
  productsContainer.innerHTML = '';
  if (!b) return;
  
  let stores = [];
  if (b === 'Both') {
    const selectaStores = brandStores['Selecta'] || [];
    const aiceStores = brandStores['Aice'] || [];
    stores = [...new Set([...selectaStores, ...aiceStores])];
  } else {
    stores = brandStores[b] || [];
  }
  
  stores.forEach(s => {
    const opt = document.createElement('option'); 
    opt.value = s; 
    opt.textContent = s; 
    storeNameEl.appendChild(opt);
  });
  
  if (b === 'Both') {
    renderProducts('Selecta');
    renderProducts('Aice');
  } else {
    renderProducts(b);
  }
});

function renderProducts(brand){
  const list = productsList[brand] || [];
  list.forEach((p) => {
    const item = document.createElement('div');
    item.className = 'product-item';
    item.innerHTML = `
      <div class="product-header">${p} <span style="font-size:11px;color:#666;">(${brand})</span></div>
      <div class="product-controls">
        <div class="status-group">
          <div class="status-option">
            <input type="checkbox" id="available_${brand}_${p.replace(/\s/g,'_')}" class="status-check" data-key="${p}" data-brand="${brand}" data-status="available">
            <label for="available_${brand}_${p.replace(/\s/g,'_')}">Available</label>
          </div>
          <div class="status-option">
            <input type="checkbox" id="notavail_${brand}_${p.replace(/\s/g,'_')}" class="status-check" data-key="${p}" data-brand="${brand}" data-status="notavailable">
            <label for="notavail_${brand}_${p.replace(/\s/g,'_')}">Not Available</label>
          </div>
          <div class="status-option">
            <input type="checkbox" id="notcarried_${brand}_${p.replace(/\s/g,'_')}" class="status-check" data-key="${p}" data-brand="${brand}" data-status="notcarried">
            <label for="notcarried_${brand}_${p.replace(/\s/g,'_')}">Not Carried</label>
          </div>
        </div>
        <div class="price-group">
          <label>Price:</label>
          <input class="price-input" data-key="${p}" data-brand="${brand}" type="number" step="0.01" placeholder="0.00" />
        </div>
      </div>
    `;
    productsContainer.appendChild(item);
  });
  
  document.querySelectorAll('.status-check').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        const key = this.dataset.key;
        const brand = this.dataset.brand;
        document.querySelectorAll(`.status-check[data-key="${key}"][data-brand="${brand}"]`).forEach(cb => {
          if (cb !== this) cb.checked = false;
        });
      }
    });
  });
}

async function startCameraFor(videoEl){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    videoEl.srcObject = s;
    return s;
  }catch(err){
    console.warn('camera start error', err);
    return null;
  }
}

function captureFromVideo(videoEl, canvasEl, maxWidth=1024){
  const vw = videoEl.videoWidth || 1280;
  const vh = videoEl.videoHeight || 720;
  let scale = 1;
  if (vw > maxWidth) scale = maxWidth / vw;
  const w = Math.round(vw * scale);
  const h = Math.round(vh * scale);
  canvasEl.width = w; canvasEl.height = h;
  const ctx = canvasEl.getContext('2d');
  ctx.drawImage(videoEl, 0, 0, w, h);
  return canvasEl.toDataURL('image/jpeg', 0.75);
}

document.getElementById('storeStartBtn').addEventListener('click', async () => { if (!storeStream) storeStream = await startCameraFor(storeVideo); });
document.getElementById('storeCaptureBtn').addEventListener('click', () => { if (storeVideo.srcObject) { storeDataURL = captureFromVideo(storeVideo, storeCanvas); storeThumb.src = storeDataURL || ''; } });
document.getElementById('cabStartBtn').addEventListener('click', async () => { if (!cabStream) cabStream = await startCameraFor(cabVideo); });
document.getElementById('cabCaptureBtn').addEventListener('click', () => { if (cabVideo.srcObject) { cabDataURL = captureFromVideo(cabVideo, cabCanvas); cabThumb.src = cabDataURL || ''; } });

// File input fallback
storeFileInput.addEventListener('change', (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = () => { storeDataURL = r.result; storeThumb.src = storeDataURL; };
  r.readAsDataURL(f);
});

cabFileInput.addEventListener('change', (ev) => {
  const f = ev.target.files && ev.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = () => { cabDataURL = r.result; cabThumb.src = cabDataURL; };
  r.readAsDataURL(f);
});

surveyForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Get location before saving
  displayStatus('üìç Getting your location...', 'info');
  await getCurrentLocation();
  
  const entry = buildEntryFromForm();
  offlineEntries.push(entry);
  localStorage.setItem('offlineEntries', JSON.stringify(offlineEntries));
  displayStatus('‚úÖ Data saved locally with location', 'success');
  renderLocalList();
  surveyForm.reset();
  storeThumb.src=''; cabThumb.src=''; storeDataURL=''; cabDataURL='';
  productsContainer.innerHTML='';
});

function buildEntryFromForm(){
  const auditorName = document.getElementById('auditorName').value;
  const area = areaEl.value;
  const municipality = municipalityEl.value;
  const barangay = document.getElementById('barangay').value;
  const brand = brandEl.value;
  const storeName = storeNameEl.value;
  const typeStore = document.getElementById('typeStore').value;
  const countCabinet = document.getElementById('countCabinet').value;
  const timestamp = new Date().toISOString();
  const productEntries = [];
  
  document.querySelectorAll('.product-item').forEach(item => {
    const header = item.querySelector('.product-header').textContent.split('(')[0].trim();
    const priceInput = item.querySelector('.price-input');
    const price = priceInput.value || '';
    const productBrand = priceInput.dataset.brand || brand;
    
    const availableCheck = item.querySelector('.status-check[data-status="available"]');
    const notAvailCheck = item.querySelector('.status-check[data-status="notavailable"]');
    const notCarriedCheck = item.querySelector('.status-check[data-status="notcarried"]');
    
    let status = '';
    if (availableCheck && availableCheck.checked) status = 'Available';
    else if (notAvailCheck && notAvailCheck.checked) status = 'Not Available';
    else if (notCarriedCheck && notCarriedCheck.checked) status = 'Not Carried';
    
    if (status) {
      productEntries.push({ product: header, brand: productBrand, status: status, price: price });
    }
  });
  
  return { 
    auditorName, 
    area, 
    municipality, 
    barangay, 
    timestamp, 
    brand, 
    storeName, 
    typeStore,
    countCabinet,
    products: productEntries, 
    storePhoto: storeDataURL, 
    cabinetPhoto: cabDataURL,
    location: currentLocation
  };
}

function renderLocalList(){
  dataList.innerHTML = '';
  entryCount.textContent = offlineEntries.length;
  if (offlineEntries.length === 0) {
    dataList.innerHTML = '<li>No data saved locally.</li>';
    return;
  }
  offlineEntries.forEach((entry, idx) => {
    const li = document.createElement('li');
    li.style.padding = '8px'; li.style.marginBottom = '6px'; li.style.background='#eef';
    const locInfo = entry.location && entry.location.latitude ? `üìç ${entry.location.latitude.toFixed(4)}, ${entry.location.longitude.toFixed(4)}` : 'üìç No location';
    li.innerHTML = `<strong>${entry.auditorName}</strong> ‚Äî ${entry.area} ‚Äî ${entry.municipality} ‚Äî ${entry.brand} ‚Äî ${entry.storeName} ‚Äî ${locInfo}
      <div style="margin-top:4px">
        <button data-idx="${idx}" class="delBtn" style="background:#dc3545;color:#fff;border:0;padding:6px;border-radius:6px">Delete</button>
      </div>`;
    dataList.appendChild(li);
  });
}

dataList.addEventListener('click', (e) => {
  if (e.target.classList.contains('delBtn')) {
    const idx = parseInt(e.target.dataset.idx);
    offlineEntries.splice(idx,1);
    localStorage.setItem('offlineEntries', JSON.stringify(offlineEntries));
    renderLocalList();
    displayStatus('Entry deleted', 'info');
  }
});

clearLocalBtn.addEventListener('click', () => {
  if (!confirm('Clear all local entries?')) return;
  offlineEntries = []; localStorage.removeItem('offlineEntries'); renderLocalList(); displayStatus('Cleared', 'info');
});

syncBtn.addEventListener('click', async () => {
  if (offlineEntries.length === 0) { displayStatus('No offline data to sync', 'error'); return; }
  if (!navigator.onLine) { displayStatus('Offline ‚Äî connect to internet to sync', 'error'); return; }
  displayStatus('‚è≥ Syncing...', 'info');
  syncBtn.disabled = true;
  const successful = [], failed = [];
  for (const entry of offlineEntries) {
    try {
      const resp = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(entry)
      });
      const text = await resp.text();
      console.log('SYNC RESPONSE', resp.status, text);
      let json = null;
      try{ json = JSON.parse(text); }catch(e){ json = { ok: resp.ok, raw: text }; }
      if (resp.ok) {
        successful.push(entry);
      } else {
        failed.push(entry);
        console.warn('sync error', resp.status, text);
      }
      await new Promise(r => setTimeout(r, 350));
    } catch (err) {
      console.error('sync exception', err);
      failed.push(entry);
    }
  }
  offlineEntries = failed;
  localStorage.setItem('offlineEntries', JSON.stringify(offlineEntries));
  renderLocalList();
  if (successful.length) displayStatus(`‚úÖ Successfully synced ${successful.length} entries`, 'success');
  else displayStatus('‚ùå No entries synced. Check console or Apps Script executions', 'error');
  syncBtn.disabled = false;
});

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();
renderLocalList();

// Get initial location on page load
getCurrentLocation().then(loc => {
  console.log('Initial location obtained:', loc);
});
</script>
</body>
</html>
